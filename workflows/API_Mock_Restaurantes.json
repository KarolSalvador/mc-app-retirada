{
  "name": "API_Mock_Restaurantes",
  "nodes": [
    {
      "parameters": {
        "path": "restaurantes",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -432,
        0
      ],
      "id": "f5f371d2-1ddd-4bb3-b3c5-d0aba7c66f49",
      "name": "Webhook",
      "webhookId": "f570395c-961d-41b4-976d-60abf59e02f4"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{JSON.stringify({data: $node[\"Code: Filtrar Restaurantes\"].json})}}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        352,
        0
      ],
      "id": "8be512b0-32d5-4ca5-8935-377b7021469b",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "content": "### Recebe a requisição do Front-End",
        "height": 240,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -496,
        -96
      ],
      "typeVersion": 1,
      "id": "abe1e1d3-708d-44e0-a482-165b6f10e0f7",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "### Busca no Postgres os restaurantes",
        "height": 240,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -224,
        -96
      ],
      "typeVersion": 1,
      "id": "86275be0-be08-409f-a62f-c89fcef6f969",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "### Retorna os dados dos restaurantes",
        "height": 240,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        288,
        -96
      ],
      "typeVersion": 1,
      "id": "75ee1ccf-c482-4119-ad91-f752ed560902",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  id,\n  nome,\n  endereco,\n  latitude,\n  longitude\nFROM\n  public.restaurantes;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -160,
        0
      ],
      "id": "e8490993-4708-46f5-9926-35a36284737a",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "1jXSWCEhJQwqNdL5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Limite máximo do raio em quilômetros\nconst MAX_DISTANCE_KM = 5;\nconst EARTH_RADIUS_KM = 6371;\n\n// Função Haversine para calcular a distância entre duas coordenadas\nfunction haversineDistance(lat1, long1, lat2, long2) {\n  const toRad = (angle) => angle * (Math.PI / 180);\n\n  const dLat = toRad(lat2 - lat1);\n  const dLon = toRad(lon2 - lon1);\n  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon /2 ) * Math.sin(dLon / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  const distance = EARTH_RADIUS_KM * c;\n\n  //retorna distância em km\n  return distance;\n}\n\n// Obter coordenadas do usuário do webhook (enviadas pelo Front End)\nconst userLat = parseFloat($nodeVersion.Webhook.json.query.lat);\nconst userLon = parseFloat($nodeVersion.Webhook.json.query.lon);\n\n// Array para armazenar os restaurantes filtrados\nconst nearbyRestaurants = [];\n\n// iterar sobre os restaurantes vindos do Postgres\nfor (const restaurant of $input.json) {\n    const resLat = parseFloat(restaurant.latitude);\n    const resLon = parseFloat(restaurant.longitude);\n\n    // Ignora restaurantes sem coordenadas válidas\n    if (isNaN(resLat) || isNaN(resLon)) continue;\n\n    // Calcula a distância\n    const distance = haversineDistance(userLat, userLon, resLat, resLon);\n\n    // Se a distância for menor ou igual ao raio máximo\n    if (distance <= MAX_DISTANCE_KM) {\n        // Adiciona a distância e arredonda-a para 1 casa decimai para exibição\n        const distanceStr = distance.toFixed(1);\n        \n        nearbyRestaurants.push({\n            // Mantém todos os dados do restaurante\n            ...restaurant,\n            // Adiciona a distância em um formato amigável\n            distancia: `${distanceStr} km de você`\n        });\n    }\n}\n\n// 3. Retornar a lista filtrada (o n8n espera um array de objetos)\nreturn nearbyRestaurants;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        112,
        0
      ],
      "id": "0979f6ec-c8d1-4fc8-83d1-2bb8195f6f3f",
      "name": "Code: Calcular Distância e Filtrar"
    },
    {
      "parameters": {
        "content": "### Cálculo da distância dos restaurantes dentro do raio de 5km",
        "height": 240,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        32,
        -96
      ],
      "typeVersion": 1,
      "id": "34f938a4-a76c-4b14-985c-72c9a13cd2f7",
      "name": "Sticky Note3"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Code: Calcular Distância e Filtrar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Calcular Distância e Filtrar": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "fd3b9825-9aad-436c-9b97-6f88c76dfdc9",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d3b453f5da3dc8025316bf0557e760f4fd6c24fbcbf610fbb4365b86af3b1255"
  },
  "id": "c1hIM80c3gP5Yqv6",
  "tags": []
}